---
up:
  - "[[切面的优先级]]"
url: https://www.cnblogs.com/kongbubihai/p/16034321.html
---
# 准备工作

### 目标类

> 2个方法，一个正常执行，一个抛出异常。

```java
package com.crab.spring.aop.demo03.advice;

public class Service1 {
    /**
     * 正常执行的方法
     */
    public String hello(String name) {
        System.out.println("hello " + name);
        return "hello " + name + "!";
    }

    /**
     * 执行抛出异常的方法
     */
    public void throwException() {
        System.out.println("throws a runtime exception");
        throw new RuntimeException("方法执行异常了");
    }
}
```

# 切面類

> 含5种通知

```java
package com.crab.spring.aop.demo03.advice.ordering;

import org.aspectj.lang.JoinPoint;
import org.aspectj.lang.ProceedingJoinPoint;
import org.aspectj.lang.annotation.*;
import org.springframework.aop.aspectj.annotation.AspectJProxyFactory;

@Aspect // 切面
public class CommonAspect {

    /**
     * 公共切点
     *  匹配Service1的所有方法
     */
    @Pointcut("execution(* com.crab.spring.aop.demo03.advice.ordering.Service1.*(..))")
    public void pc(){

    }

    /**
     * 前置通知
     */
    @Before("pc()")
    public void before(JoinPoint joinpoint){
        System.out.println("Before: " +  joinpoint);
    }

    /**
     * 返回通知
     */
    @AfterReturning("pc()")
    public void afterReturning(JoinPoint joinpoint){
        System.out.println("AfterReturning: " +  joinpoint);
    }

    /**
     * 抛出异常通知
     */
    @AfterThrowing("pc()")
    public void afterThrowing(JoinPoint joinpoint){
        System.out.println("AfterThrowing: " +  joinpoint);
    }

    /**
     * 最终通知
     */
    @After("pc()")
    public void after(JoinPoint joinpoint){
        System.out.println("After: " +  joinpoint);
    }

    /**
     * 最终通知
     */
    @Around("pc()")
    public Object around(ProceedingJoinPoint pdj) throws Throwable {
        System.out.println("Around start: " + pdj);
        Object ret = pdj.proceed();
        System.out.println("Around end: " + pdj);
        return ret;
    }

    public static void main(String[] args) {
        Service1 target = new Service1();
        AspectJProxyFactory proxyFactory = new AspectJProxyFactory();
        proxyFactory.setTarget(target);
        // 添加切面
        proxyFactory.addAspect(CommonAspect.class);
        Service1 proxy = proxyFactory.getProxy();
        // 方法调用
        proxy.hello("xx");
        System.out.println("\n执行异常的结果：");
        proxy.throwException();
    }
}
```

---

# 同一个切面内不同通知类型的顺序

![[1295651-20220321134351727-63619957.png]]

### 1. 方法正常执行通知顺序
    
```shell
Around start
Before:
目标方法执行
AfterReturning
After
Around end
```
    
### 2. 方法抛出异常退出通知顺序
    
```shell
Around start
Before
目标方法执行
AfterThrowing
After
```

---

# 多个切面之间的通知顺序

1. 切面级别的优先级可以通过注解`@Order`或是实现接口`org.springframework.core.Ordered`，数值越小优先级越高。

2. 类似洋葱圈，前置方向的优先级越高，后置方向的优先级越低。

![[1295651-20220321134352045-335833014.jpg]]

结论如下(以2个切面为例)

![[1295651-20220321134352389-1171205370.png]]

### 方法正常执行

```shell
Around1 start
Before1
Around2 start
Before2
目标方法执行
AfterReturning2
After2
Around2 end
AfterReturning
Afte
Around end
```

### 方法异常退出

```shell
执行异常的结果：
Around start
Before
Around2 start
Before2
目标方法执行并抛出异常
AfterThrowing2
After2
AfterThrowing
After
```


---