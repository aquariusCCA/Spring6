---
up:
  - "[[Spring6 課程描述]]"
  - "[[数据校验]]"
---
# **第一步 自定义校验注解**

> **目標**：`@StrongPassword`，要求至少 8 碼、含大小寫與數字。

```java
@Target({ElementType.METHOD, ElementType.FIELD, ElementType.ANNOTATION_TYPE, ElementType.CONSTRUCTOR, ElementType.PARAMETER})  
@Retention(RetentionPolicy.RUNTIME)  
// @Target 和 @Retention 来定义注解的使用范围和生命周期  
@Documented  
// @Constraint 标记该注解为校验注解，并指定对应的校验器类  
@Constraint(validatedBy = {CannotBlankValidator.class})  
public @interface CannotBlank {  
    //默认错误消息  
    String message() default "不能包含空格";  
  
    //分组  
    Class<?>[] groups() default {};  
  
    //负载  
    Class<? extends Payload>[] payload() default {};  
  
    //指定多个时使用  
    @Target({ElementType.METHOD, ElementType.FIELD, ElementType.ANNOTATION_TYPE, ElementType.CONSTRUCTOR, ElementType.PARAMETER, ElementType.TYPE_USE})  
    @Retention(RetentionPolicy.RUNTIME)  
    @Documented  
    @interface List {  
        CannotBlank[] value();  
    }  
}
```

> [!NOTE] **注意**
> 
> 注解本身并不会实现具体的校验逻辑，而是通过校验器类 `CannotBlankValidator` 来实现校验的具体逻辑。

> [!NOTE] **補充**
> 
> - @Target 注解用于指定注解的使用范围，包括方法、字段、注解类型、构造函数、参数。
> - @Retention 注解用于指定注解的生命周期，即在运行时仍然保留注解信息。
> - @Documented 注解用于指示该注解应该被包含在生成的文档中。
> - @Constraint 注解标记该注解为校验注解，并指定对应的校验器类 CannotBlankValidator。
> - message() 方法定义了默认的错误消息，当校验失败时使用该消息。
> - groups() 方法用于分组校验，可以指定校验器在哪个分组生效。
> - payload() 方法指定负载类型，可在自定义校验器中使用。
> - @List 注解用于指定多个 @CannotBlank 注解时使用，可以对多个注解进行组合。

---

# **第二步 编写真正的校验类**

```java
public class CannotBlankValidator implements ConstraintValidator<CannotBlank, String> {  
  
    // initialize() 方法用于初始化校验器，在校验之前进行一些初始化操作。可以获取注解中的属性值，并进行相应的处理  
    @Override  
    public void initialize(CannotBlank constraintAnnotation) {  
    }  
  
    // isValid() 方法是校验的核心逻辑，用于判断被校验的值是否符合自定义的校验规则  
    @Override  
    public boolean isValid(String value, ConstraintValidatorContext context) {  
        //null时不进行校验  
        if (value != null && value.contains(" ")) {  
            //获取默认提示信息  
            String defaultConstraintMessageTemplate = context.getDefaultConstraintMessageTemplate();  
            System.out.println("default message :" + defaultConstraintMessageTemplate);  
            //禁用默认提示信息  
            context.disableDefaultConstraintViolation();  
            //设置提示语  
            context.buildConstraintViolationWithTemplate("can not contains blank").addConstraintViolation();  
            return false;  
        }  
        return true;  
    }  
}
```

- 创建自定义的校验器类：实现 ConstraintValidator 接口，并指定要校验的注解类型和校验的值类型。在校验逻辑中，实现自定义的校验规则，根据需要返回校验结果

- 在 isValid() 方法中，有两个参数：
	- value: 被校验的值，即需要进行校验的字段或方法参数的值。
	- context: 校验器的上下文对象，用于控制校验过程中的一些行为和设置。

- 在实现 isValid() 方法时，根据自定义的校验规则，可以使用 value 参数获取被校验的值，并根据业务逻辑进行校验。如果校验成功，返回 true 表示校验通过；如果校验失败，返回 false 表示校验不通过。

---

# 第三步 測試

```java
@Configuration  
@ComponentScan("com.atguigu.spring6")  
public class SpringConfig {  }
```

```java
public class UserDto {  
    @CannotBlank(message = "xxxxx")  
    private String password;  
  
    public String getPassword() {  
        return password;  
    }  
  
    public void setPassword(String password) {  
        this.password = password;  
    }  
}
```

```java
@Test  
public void test(){  
    ApplicationContext context = new AnnotationConfigApplicationContext(SpringConfig.class);  
    MyService1 myService1 = context.getBean(MyService1.class);  
    UserDto userDto = new UserDto();  
    userDto.setPassword("1234 56");  
    myService1.testParams(userDto);  
}
```